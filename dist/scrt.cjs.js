"use strict";var Te=Object.defineProperty;var De=(t,e,n)=>e in t?Te(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var u=(t,e,n)=>De(t,typeof e!="symbol"?e+"":e,n);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});function y(){return[]}function Ee(t){return t.length}function b(t,e){t.push(e&255)}function I(t,e){for(let n=0;n<e.length;n+=1)t.push(e[n]&255)}function Y(t){return Uint8Array.from(t)}function J(t){const e=t.reduce((i,s)=>i+s.length,0),n=new Uint8Array(e);let r=0;for(const i of t)n.set(Uint8Array.from(i),r),r+=i.length;return n}const xe=10;function m(t,e){let n=BigInt(e);if(n<0n)throw new RangeError("uvarint cannot be negative");for(;n>=0x80n;)b(t,Number(n&0x7fn|0x80n)),n>>=7n;b(t,Number(n))}function U(t,e){let n=Se(BigInt(e));for(;n>=0x80n;)b(t,Number(n&0x7fn|0x80n)),n>>=7n;b(t,Number(n))}function h(t,e){let n=0n,r=0n;for(let i=0;i<xe;i+=1){if(e+i>=t.length)throw new RangeError("uvarint exceeds buffer");const s=BigInt(t[e+i]);if((s&0x80n)===0n)return n|=(s&0x7fn)<<r,{value:n,bytesRead:i+1};n|=(s&0x7fn)<<r,r+=7n}throw new RangeError("uvarint too large")}function D(t,e){const{value:n,bytesRead:r}=h(t,e);return{value:Ne(n),bytesRead:r}}function Se(t){return t<<1n^t>>63n}function Ne(t){return t>>1n^-(t&1n)}class Re{constructor(){u(this,"chunks",[]);u(this,"current",y())}writeByte(e){b(this.current,e)}writeBytes(e){I(this.current,e)}writeBuffer(e){this.flushCurrent(),this.chunks.push(e.slice()),this.current=y()}writeUint8Array(e){this.flushCurrent(),this.chunks.push(Array.from(e)),this.current=y()}writeUvarint(e){m(this.current,e)}toUint8Array(){return this.flushCurrent(),J(this.chunks)}reset(){this.chunks.length=0,this.current=y()}flushCurrent(){this.current.length>0&&(this.chunks.push(this.current),this.current=y())}}class $e{constructor(e,n=0){u(this,"data");u(this,"offset");this.data=e,this.offset=n}ensure(e){if(this.offset+e>this.data.length)throw new RangeError("buffer underrun")}readByte(){return this.ensure(1),this.data[this.offset++]}readBytes(e){this.ensure(e);const n=this.data.subarray(this.offset,this.offset+e);return this.offset+=e,n}readUvarint(){const{value:e,bytesRead:n}=h(this.data,this.offset);return this.offset+=n,e}readVarint(){const{value:e,bytesRead:n}=D(this.data,this.offset);return this.offset+=n,e}remaining(){return this.data.length-this.offset}}function Ue(t,e){const n=Number(t);if(!Number.isFinite(n)||n>Number.MAX_SAFE_INTEGER)throw new RangeError(`${e} exceeds safe number range`);return n}function ke(t){const e=BigInt(t),n=new Uint8Array(8);let r=e;for(let i=0;i<8;i+=1)n[i]=Number(r&0xffn),r>>=8n;return n}const Ae=new TextEncoder;class Ce{constructor(){u(this,"values",[])}append(e){this.values.push(BigInt(e))}encode(e){const n=this.values.length,r=n>=2&&We(this.values)?1n:0n,i=BigInt(n)<<1n|r;if(m(e,i),n===0)return;if(r===0n){for(const o of this.values)m(e,o);return}m(e,this.values[0]);let s=this.values[0];for(let o=1;o<n;o+=1){const a=this.values[o]-s;m(e,a),s=this.values[o]}}reset(){this.values.length=0}}class ve{constructor(){u(this,"values",[])}append(e){this.values.push(BigInt(e))}encode(e){const n=this.values.length,r=n>1?1n:0n,i=BigInt(n)<<1n|r;if(m(e,i),n===0)return;if(r===0n){for(const o of this.values)U(e,o);return}U(e,this.values[0]);let s=this.values[0];for(let o=1;o<n;o+=1){const a=this.values[o]-s;U(e,a),s=this.values[o]}}reset(){this.values.length=0}}class Ve{constructor(){u(this,"values",[])}append(e){this.values.push(e)}encode(e){m(e,this.values.length);for(const n of this.values)Ze(e,n)}reset(){this.values.length=0}}class Me{constructor(){u(this,"values",[])}append(e){this.values.push(e?1:0)}encode(e){m(e,this.values.length);for(const n of this.values)b(e,n)}reset(){this.values.length=0}}class Le{constructor(){u(this,"dict",new Map);u(this,"entries",[]);u(this,"indexes",[])}append(e){if(!this.dict.has(e)){const n=Ae.encode(e);this.dict.set(e,this.entries.length),this.entries.push(n)}this.indexes.push(this.dict.get(e))}encode(e){m(e,this.entries.length);for(const n of this.entries)m(e,n.length),I(e,n);m(e,this.indexes.length);for(const n of this.indexes)m(e,BigInt(n))}reset(){this.dict.clear(),this.entries.length=0,this.indexes.length=0}}class Oe{constructor(){u(this,"values",[])}append(e){const n=new Uint8Array(e.length);n.set(e),this.values.push(n)}encode(e){m(e,this.values.length);for(const n of this.values)m(e,n.length),I(e,n)}reset(){this.values.length=0}}function We(t){for(let e=1;e<t.length;e+=1)if(t[e]<t[e-1])return!1;return!0}function Ze(t,e){const n=new ArrayBuffer(8),r=new DataView(n);r.setFloat64(0,e,!0);for(let i=0;i<8;i+=1)b(t,r.getUint8(i))}const _e=/^(\d{4})-(\d{2})-(\d{2})$/,ze=/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{1,9}))?)?$/,Q=/^[-+]?\d+(?:\.\d+)?$/,Pe=/(\d+(?:\.\d+)?)(ns|us|µs|ms|s|m|h|d)/gi,je={ns:1n,us:1000n,µs:1000n,ms:1000000n,s:1000000000n,m:60n*1000000000n,h:60n*60n*1000000000n,d:24n*60n*60n*1000000000n};function x(t){const e=t.trim(),n=_e.exec(e);if(!n){const o=new Date(e);if(Number.isNaN(o.getTime()))throw new Error(`temporal: invalid date ${t}`);return V(o.getUTCFullYear(),o.getUTCMonth(),o.getUTCDate())}const[,r,i,s]=n;return V(Number(r),Number(i)-1,Number(s))}function S(t){const e=t.trim(),n=ze.exec(e);if(!n){const g=new Date(e);if(Number.isNaN(g.getTime()))throw new Error(`temporal: invalid datetime ${t}`);return new Date(g.toISOString())}const[,r,i,s,o,a,c="0",d="0"]=n,f=He(d),l=Date.UTC(Number(r),Number(i)-1,Number(s),Number(o),Number(a),Number(c));return new Date(l+Number(f/1000000n))}function E(t){const e=t.trim();if(Q.test(e))return W(e);const n=new Date(e);return Number.isNaN(n.getTime())?S(e):new Date(n.toISOString())}function N(t){const e=t.trim();if(Q.test(e))return W(e);const n=new Date(e);if(Number.isNaN(n.getTime()))throw new Error(`temporal: invalid timestamptz ${t}`);return n}function C(t){const e=t.trim();if(!e)throw new Error("temporal: empty duration");let n=0n,r=!1;for(const i of e.matchAll(Pe)){r=!0;const[,s,o]=i,a=o.toLowerCase(),c=je[a];if(!c)throw new Error(`temporal: unsupported duration unit ${o}`);const[d,f="0"]=s.split(".");let l=BigInt(d)*c;if(f){const g=c/se(f.length);l+=BigInt(f)*g}n+=l}if(!r)throw new Error(`temporal: malformed duration ${t}`);return n}function k(t){return t instanceof Date?BigInt(t.getTime())*1000000n:typeof t=="number"?BigInt(Math.trunc(t))*1000000n:t}function O(t){if(t instanceof Date){const n=V(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate());return BigInt(n.getTime())*1000000n}const e=x(t);return BigInt(e.getTime())*1000000n}function K(t){return t.toISOString()}function ee(t){if(!t.trim())return"";const e=N(t);return K(e)}function T(t){const e=BigInt(t);if(e===0n)return new Date(0);const n=Number(e/1000000n);return new Date(n)}function te(t){return T(t)}function ne(t){return Number.isFinite(t.getTime())?t.toISOString().slice(0,10):""}function re(t){return Number.isFinite(t.getTime())?t.toISOString():""}function W(t){if(t.includes(".")){const[r,i]=t.split("."),s=BigInt(r),o=BigInt(se(i.length)),a=BigInt(i)*1000000000n/o;return new Date(Number(s*1000n+a/1000000n))}const e=BigInt(t),n=v(e);return new Date(Number(n/1000000n))}function v(t){const e=t<0n?-t:t;return e<100000000000n?t*1000000000n:e<100000000000000n?t*1000000n:e<100000000000000000n?t*1000n:t}const Ge=[{nanos:24n*60n*60n*1000000000n,suffix:"d"},{nanos:60n*60n*1000000000n,suffix:"h"},{nanos:60n*1000000000n,suffix:"m"},{nanos:1000000000n,suffix:"s"},{nanos:1000000n,suffix:"ms"},{nanos:1000n,suffix:"µs"},{nanos:1n,suffix:"ns"}];function ie(t){if(t===0n)return"0s";const e=t<0n;let n=e?-t:t;const r=[];for(const i of Ge){if(n<i.nanos)continue;const s=n/i.nanos;if(n-=s*i.nanos,r.push(`${s}${i.suffix}`),n===0n)break}return n>0n&&r.push(`${n}ns`),`${e?"-":""}${r.join("")}`}function V(t,e,n){return new Date(Date.UTC(t,e,n,0,0,0,0))}function He(t){const e=t.padEnd(9,"0").slice(0,9);return BigInt(e)}function se(t){let e=1n;for(let n=0;n<t;n+=1)e*=10n;return e}const Xe=0xcbf29ce484222325n,qe=0x100000001b3n;exports.FieldKind=void 0;(function(t){t[t.Invalid=0]="Invalid",t[t.Uint64=1]="Uint64",t[t.String=2]="String",t[t.Ref=3]="Ref",t[t.Bool=4]="Bool",t[t.Int64=5]="Int64",t[t.Float64=6]="Float64",t[t.Bytes=7]="Bytes",t[t.Date=8]="Date",t[t.DateTime=9]="DateTime",t[t.Timestamp=10]="Timestamp",t[t.TimestampTZ=11]="TimestampTZ",t[t.Duration=12]="Duration"})(exports.FieldKind||(exports.FieldKind={}));class w{constructor(e,n,r,i,s,o,a){u(this,"kind");u(this,"boolValue");u(this,"intValue");u(this,"uintValue");u(this,"floatValue");u(this,"stringValue");u(this,"bytesValue");this.kind=e,this.boolValue=n,this.intValue=r,this.uintValue=i,this.floatValue=s,this.stringValue=o,this.bytesValue=a}hashKey(){switch(this.kind){case exports.FieldKind.Bool:return`bool:${this.boolValue?1:0}`;case exports.FieldKind.Int64:return`int:${this.intValue??0n}`;case exports.FieldKind.Uint64:case exports.FieldKind.Ref:return`uint:${this.uintValue??0n}`;case exports.FieldKind.Float64:return`float:${this.floatValue??0}`;case exports.FieldKind.String:return`string:${this.stringValue??""}`;case exports.FieldKind.Bytes:return`bytes:${dt(this.bytesValue??new Uint8Array)}`;case exports.FieldKind.Date:case exports.FieldKind.DateTime:case exports.FieldKind.Timestamp:case exports.FieldKind.Duration:return`int:${this.intValue??0n}`;case exports.FieldKind.TimestampTZ:return`timestamptz:${this.stringValue??""}`;default:return""}}}class oe{constructor(e,n,r,i="",s="",o=!1,a=[],c){u(this,"name");u(this,"kind");u(this,"rawType");u(this,"targetSchema");u(this,"targetField");u(this,"autoIncrement");u(this,"attributes");u(this,"defaultValue");u(this,"resolvedKind",exports.FieldKind.Invalid);u(this,"pendingDefault","");this.name=e,this.kind=n,this.rawType=r,this.targetSchema=i,this.targetField=s,this.autoIncrement=o,this.attributes=a,this.defaultValue=c}valueKind(){return this.kind===exports.FieldKind.Ref?this.resolvedKind===exports.FieldKind.Invalid?exports.FieldKind.Uint64:this.resolvedKind:this.resolvedKind===exports.FieldKind.Invalid?this.kind:this.resolvedKind}isReference(){return this.kind===exports.FieldKind.Ref&&!!this.targetSchema&&!!this.targetField}}class ae{constructor(e,n){u(this,"name");u(this,"fields");u(this,"fingerprintCache");u(this,"fieldIndex");this.name=e,this.fields=n}fingerprint(){if(this.fingerprintCache!==void 0)return this.fingerprintCache;let e=Xe;const n=r=>{for(let i=0;i<r.length;i+=1)e^=BigInt(r.charCodeAt(i)),e=BigInt.asUintN(64,e*qe)};n(this.name);for(const r of this.fields){if(n("|"),n(r.name),n(":"),n(r.rawType),r.targetSchema&&(n("->"),n(`${r.targetSchema}.${r.targetField}`)),r.autoIncrement&&n("+auto"),r.attributes.length){const i=[...r.attributes].sort();for(const s of i)n(`@${s}`)}r.defaultValue&&(n("=def:"),n(r.defaultValue.hashKey()))}return this.fingerprintCache=BigInt.asUintN(64,e),this.fingerprintCache}fieldIndexByName(e){this.fieldIndex||(this.fieldIndex=new Map,this.fields.forEach((r,i)=>this.fieldIndex.set(r.name,i)));const n=this.fieldIndex.get(e);if(n===void 0)throw new Error(`scrt: field ${e} not found in schema ${this.name}`);return n}tryFieldIndex(e){return this.fieldIndex||(this.fieldIndex=new Map,this.fields.forEach((n,r)=>this.fieldIndex.set(n.name,r))),this.fieldIndex.get(e)}}class ce{constructor(e,n,r){u(this,"schemas");u(this,"data");u(this,"source");this.schemas=e,this.data=n,this.source=r}schema(e){return this.schemas.get(e)}records(e){return this.data.get(e)}finalize(){for(const e of this.schemas.values())ut(this,e)}}function Ye(t){const e=t.split(/\r?\n/).map(f=>f.trim()),n=new Map,r=new Map;let i,s=!1,o="";const a=()=>{if(i){if(n.has(i.name))throw new Error(`scrt: duplicate schema ${i.name}`);n.set(i.name,i),i=void 0}},c=f=>{if(a(),!f)throw new Error("scrt: schema name cannot be empty");i=new ae(f,[])};for(const f of e)if(f){if(s){c(f),s=!1;continue}if(f.startsWith("@schema")){o="";let l=f.slice(7).trim();if(l.startsWith(":")&&(l=l.slice(1).trim()),!l){s=!0;continue}c(l);continue}if(f.startsWith("@field")){if(o="",!i)throw new Error("scrt: @field outside schema block");const l=Je(f.slice(6).trim());i.fields.push(l);continue}if(f.startsWith("@")){if(s=!1,a(),f.includes("=")&&o){const l=n.get(o);if(l){const g=z(f,l);_(r,o,g)}continue}o=f.slice(1).trim();continue}if(o){const l=n.get(o);if(!l)continue;const g=z(f,l);_(r,o,g);continue}}a();const d=new ce(n,r);return d.finalize(),d}function _(t,e,n){t.has(e)||t.set(e,[]),t.get(e).push(n)}function Je(t){const[e,n,r]=Qe(t),{kind:i,targetSchema:s,targetField:o}=et(n),a=new oe(e,i,n,s,o);if(r){const c=tt(r);for(const d of c){const f=d.toLowerCase();switch(!0){case(f==="auto_increment"||f==="autoincrement"||f==="serial"):a.autoIncrement=!0;break;case f.startsWith("default="):case f.startsWith("default:"):nt(a,rt(d));break}a.attributes.push(f)}}return a}function Qe(t){const e=t.trim(),n=e.search(/[ \t]/);if(n===-1)throw new Error(`scrt: invalid @field declaration ${t}`);const r=e.slice(0,n).trim(),i=e.slice(n+1).trim(),s=i.search(/[ \t]/);return s===-1?[r,i,""]:[r,i.slice(0,s).trim(),i.slice(s+1).trim()]}function et(t){const e=t.toLowerCase();switch(!0){case e==="uint64":return{kind:exports.FieldKind.Uint64,targetSchema:"",targetField:""};case e==="string":return{kind:exports.FieldKind.String,targetSchema:"",targetField:""};case e==="bool":return{kind:exports.FieldKind.Bool,targetSchema:"",targetField:""};case e==="int64":return{kind:exports.FieldKind.Int64,targetSchema:"",targetField:""};case e==="float64":return{kind:exports.FieldKind.Float64,targetSchema:"",targetField:""};case e==="bytes":return{kind:exports.FieldKind.Bytes,targetSchema:"",targetField:""};case e==="date":return{kind:exports.FieldKind.Date,targetSchema:"",targetField:""};case e==="datetime":return{kind:exports.FieldKind.DateTime,targetSchema:"",targetField:""};case e==="timestamp":return{kind:exports.FieldKind.Timestamp,targetSchema:"",targetField:""};case e==="timestamptz":return{kind:exports.FieldKind.TimestampTZ,targetSchema:"",targetField:""};case e==="duration":return{kind:exports.FieldKind.Duration,targetSchema:"",targetField:""};case e.startsWith("ref:"):const[,n,r]=t.split(":");return{kind:exports.FieldKind.Ref,targetSchema:n??"",targetField:r??""};default:throw new Error(`scrt: unsupported field type ${t}`)}}function tt(t){const e=[];let n="",r=null;for(const i of t)(i==='"'||i==="'"||i==="`")&&r===null?(r=i,n+=i):r&&i===r?(r=null,n+=i):!r&&i===","?(n.trim()&&e.push(n.trim()),n=""):n+=i;return n.trim()&&e.push(n.trim()),e}function nt(t,e){const n=e.trim();if(n){if(t.kind===exports.FieldKind.Ref){t.pendingDefault=n;return}t.defaultValue=M(t.kind,n)}}function rt(t){const e=t.indexOf("=")>=0?t.indexOf("="):t.indexOf(":");return e===-1?t:t.slice(e+1)}function M(t,e){switch(t){case exports.FieldKind.Bool:return new w(t,e.toLowerCase()==="true"||e==="1");case exports.FieldKind.Int64:return new w(t,void 0,BigInt(e));case exports.FieldKind.Uint64:case exports.FieldKind.Ref:return new w(t,void 0,void 0,BigInt(e));case exports.FieldKind.Float64:return new w(t,void 0,void 0,void 0,Number(e));case exports.FieldKind.String:return new w(t,void 0,void 0,void 0,void 0,it(e));case exports.FieldKind.Bytes:return new w(t,void 0,void 0,void 0,void 0,void 0,ue(e));case exports.FieldKind.Date:return new w(t,void 0,O(x(p(e))));case exports.FieldKind.DateTime:return new w(t,void 0,k(S(p(e))));case exports.FieldKind.Timestamp:return new w(t,void 0,k(E(p(e))));case exports.FieldKind.TimestampTZ:{const n=N(p(e));return new w(t,void 0,void 0,void 0,void 0,K(n))}case exports.FieldKind.Duration:return new w(t,void 0,C(p(e)));default:throw new Error(`scrt: defaults not supported for kind ${t}`)}}function it(t){const e=t.trim();return e?e.startsWith('"')||e.startsWith("'")||e.startsWith("`")?e.slice(1,-1):e:""}function p(t){const e=t.trim();return e?e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")||e.startsWith("`")&&e.endsWith("`")?e.slice(1,-1):e:""}function ue(t){const e=t.trim();if(e.startsWith("0x")||e.startsWith("0X")){const n=e.slice(2);if(n.length%2!==0)throw new Error(`scrt: invalid hex literal ${t}`);const r=new Uint8Array(n.length/2);for(let i=0;i<n.length;i+=2)r[i/2]=parseInt(n.slice(i,i+2),16);return r}return new TextEncoder().encode(p(e))}function z(t,e){const n={},r=t.split(",");let i=0,s=st(r);const o=()=>{for(;i<e.fields.length&&e.fields[i].autoIncrement;){const a=ot(e.fields,i);if(s>a)return;i+=1}};for(const a of r){const c=a.trim();if(!c){i+=1;continue}if(c.startsWith("@")){const{index:f,value:l}=at(e,c.slice(1));f>=0&&(n[e.fields[f].name]=l,i=Math.max(i,f+1));continue}if(o(),i>=e.fields.length)throw new Error("scrt: too many values in row");const d=e.fields[i];n[d.name]=de(c,d),i+=1,s-=1}return n}function st(t){return t.reduce((e,n)=>{const r=n.trim();return!r||r.startsWith("@")?e:e+1},0)}function ot(t,e){let n=0;for(let r=e;r<t.length;r+=1)t[r].autoIncrement||(n+=1);return n}function at(t,e){const[n,r]=e.split("=",2);if(!r)throw new Error(`scrt: invalid assignment ${e}`);const i=ct(n),s=t.tryFieldIndex(i);if(s===void 0)throw new Error(`scrt: field ${i} not found`);const o=t.fields[s];return{index:s,value:de(r.trim(),o)}}function ct(t){const n=t.trim().split(":");return n.length>=2?n[1]:n[0]}function de(t,e){const n=e.valueKind(),r=t.trim();switch(n){case exports.FieldKind.Uint64:return BigInt(r);case exports.FieldKind.Int64:return BigInt(r);case exports.FieldKind.Float64:return Number(r);case exports.FieldKind.Bool:return r.toLowerCase()==="true"||r==="1";case exports.FieldKind.String:return p(r);case exports.FieldKind.Bytes:return ue(r);case exports.FieldKind.Date:return x(p(r));case exports.FieldKind.DateTime:return S(p(r));case exports.FieldKind.Timestamp:return E(p(r));case exports.FieldKind.TimestampTZ:return N(p(r));case exports.FieldKind.Duration:return C(p(r));default:return r}}function ut(t,e){e.fields.forEach((n,r)=>fe(t,e,r,new Set))}function fe(t,e,n,r){const i=e.fields[n];if(i.resolvedKind!==exports.FieldKind.Invalid)return i.resolvedKind;if(i.kind!==exports.FieldKind.Ref)return i.resolvedKind=i.kind,i.pendingDefault&&!i.defaultValue&&(i.defaultValue=M(i.resolvedKind,i.pendingDefault),i.pendingDefault=""),i.resolvedKind;const s=`${e.name}.${i.name}`;if(r.has(s))throw new Error(`scrt: circular reference detected for ${s}`);r.add(s);const o=t.schemas.get(i.targetSchema);if(!o)throw new Error(`scrt: schema ${e.name} references unknown schema ${i.targetSchema}`);const a=o.tryFieldIndex(i.targetField);if(a===void 0)throw new Error(`scrt: schema ${e.name} references unknown field ${i.targetSchema}.${i.targetField}`);const c=fe(t,o,a,r);return i.resolvedKind=c,r.delete(s),i.pendingDefault&&!i.defaultValue&&(i.defaultValue=M(c,i.pendingDefault),i.pendingDefault=""),c}function dt(t){if(typeof Buffer<"u")return Buffer.from(t).toString("base64");let e="";for(let n=0;n<t.length;n+=1)e+=String.fromCharCode(t[n]);if(typeof btoa=="function")return btoa(e);throw new Error("scrt: base64 encoding unavailable in this environment")}class ft{constructor(e,n=1024){u(this,"schema");u(this,"rowLimit");u(this,"columns");u(this,"columnBuf",y());u(this,"rows",0);this.schema=e,this.rowLimit=n,this.columns=e.fields.map(r=>{const i=r.valueKind(),s={kind:i,presence:[]};switch(i){case exports.FieldKind.Uint64:case exports.FieldKind.Ref:s.uints=new Ce;break;case exports.FieldKind.String:case exports.FieldKind.TimestampTZ:s.strings=new Le;break;case exports.FieldKind.Bool:s.bools=new Me;break;case exports.FieldKind.Int64:case exports.FieldKind.Date:case exports.FieldKind.DateTime:case exports.FieldKind.Timestamp:case exports.FieldKind.Duration:s.ints=new ve;break;case exports.FieldKind.Float64:s.floats=new Ve;break;case exports.FieldKind.Bytes:s.bytes=new Oe;break;default:throw new Error(`scrt: unsupported field kind ${i}`)}return s})}appendUint(e,n){var r;(r=this.columns[e].uints)==null||r.append(n)}appendString(e,n){var r;(r=this.columns[e].strings)==null||r.append(n)}appendBool(e,n){var r;(r=this.columns[e].bools)==null||r.append(n)}appendInt(e,n){var r;(r=this.columns[e].ints)==null||r.append(n)}appendFloat(e,n){var r;(r=this.columns[e].floats)==null||r.append(n)}appendBytes(e,n){var r;(r=this.columns[e].bytes)==null||r.append(n)}recordPresence(e,n){this.columns[e].presence.push(n)}sealRow(){if(this.rows+=1,this.rows>this.rowLimit)throw new Error("scrt: page builder capacity exceeded")}full(){return this.rows>=this.rowLimit}rowCount(){return this.rows}reset(){var e,n,r,i,s,o;this.rows=0;for(const a of this.columns)a.presence.length=0,(e=a.uints)==null||e.reset(),(n=a.strings)==null||n.reset(),(r=a.bools)==null||r.reset(),(i=a.ints)==null||i.reset(),(s=a.floats)==null||s.reset(),(o=a.bytes)==null||o.reset()}encode(e){var n,r,i,s,o,a;if(this.rows!==0){m(e,this.rows),m(e,this.columns.length);for(let c=0;c<this.columns.length;c+=1){const d=this.columns[c];switch(this.columnBuf.length=0,lt(this.columnBuf,d.presence,this.rows),d.kind){case exports.FieldKind.Uint64:case exports.FieldKind.Ref:(n=d.uints)==null||n.encode(this.columnBuf);break;case exports.FieldKind.String:case exports.FieldKind.TimestampTZ:(r=d.strings)==null||r.encode(this.columnBuf);break;case exports.FieldKind.Bool:(i=d.bools)==null||i.encode(this.columnBuf);break;case exports.FieldKind.Int64:case exports.FieldKind.Date:case exports.FieldKind.DateTime:case exports.FieldKind.Timestamp:case exports.FieldKind.Duration:(s=d.ints)==null||s.encode(this.columnBuf);break;case exports.FieldKind.Float64:(o=d.floats)==null||o.encode(this.columnBuf);break;case exports.FieldKind.Bytes:(a=d.bytes)==null||a.encode(this.columnBuf);break;default:throw new Error(`scrt: unsupported field kind ${d.kind}`)}m(e,c),b(e,d.kind),m(e,this.columnBuf.length),I(e,this.columnBuf)}}}}function lt(t,e,n){const r=Math.floor((n+7)/8);if(m(t,r),r===0)return;let i=0,s=0,o=0;for(let a=0;a<n;a+=1)e[a]&&(i|=1<<s),s+=1,s===8&&(b(t,i),o+=1,i=0,s=0);for(s!==0&&(b(t,i),o+=1);o<r;)b(t,0),o+=1}const F="SCRT",le=2,he=new TextDecoder;class A{constructor(e){u(this,"schema");u(this,"values");this.schema=e,this.values=new Array(e.fields.length).fill(null).map(()=>({set:!1}))}reset(){for(const e of this.values)e.set=!1,e.uint=void 0,e.int=void 0,e.float=void 0,e.str=void 0,e.bytes=void 0,e.bool=void 0,e.borrowed=void 0}setByIndex(e,n){this.values[e]={...n,set:!0}}valuesSlice(){return this.values}fieldIndex(e){return this.schema.fieldIndexByName(e)}setValue(e,n){this.setByIndex(this.fieldIndex(e),n)}setUint(e,n){const r=this.claimSlot(this.fieldIndex(e));r.uint=BigInt(n)}setInt(e,n){const r=this.claimSlot(this.fieldIndex(e));r.int=BigInt(n)}setFloat(e,n){const r=this.claimSlot(this.fieldIndex(e));r.float=n}setBool(e,n){const r=this.claimSlot(this.fieldIndex(e));r.bool=n}setString(e,n){const r=this.claimSlot(this.fieldIndex(e));r.str=n}setBytes(e,n){const r=this.claimSlot(this.fieldIndex(e));r.bytes=Z(n)}claimSlot(e){const n=this.values[e];return n.set=!0,n.uint=void 0,n.int=void 0,n.float=void 0,n.str=void 0,n.bytes=void 0,n.bool=void 0,n.borrowed=!1,n}}class me{constructor(e,n=1024){u(this,"schema");u(this,"builder");u(this,"output",y());u(this,"headerWritten",!1);this.schema=e,this.builder=new ft(e,n)}writeRow(e){if(e.schema!==this.schema)throw new Error("scrt: schema mismatch for row");this.ensureHeader();const n=e.valuesSlice();this.schema.fields.forEach((r,i)=>{const s=n[i];if(!s.set){this.builder.recordPresence(i,!1);return}switch(this.builder.recordPresence(i,!0),r.valueKind()){case exports.FieldKind.Uint64:case exports.FieldKind.Ref:this.builder.appendUint(i,s.uint??0n);break;case exports.FieldKind.String:case exports.FieldKind.TimestampTZ:this.builder.appendString(i,s.str??"");break;case exports.FieldKind.Bool:this.builder.appendBool(i,s.bool??!1);break;case exports.FieldKind.Int64:case exports.FieldKind.Date:case exports.FieldKind.DateTime:case exports.FieldKind.Timestamp:case exports.FieldKind.Duration:this.builder.appendInt(i,s.int??0n);break;case exports.FieldKind.Float64:this.builder.appendFloat(i,s.float??0);break;case exports.FieldKind.Bytes:this.builder.appendBytes(i,s.bytes??new Uint8Array);break;default:throw new Error(`scrt: unsupported field kind ${r.valueKind()}`)}}),this.builder.sealRow(),this.builder.full()&&this.flushPage()}finish(){return this.flushPage(),Y(this.output)}ensureHeader(){if(this.headerWritten)return;for(const i of F)this.output.push(i.charCodeAt(0));this.output.push(le);const e=this.schema.fingerprint(),n=new Uint8Array(8);let r=e;for(let i=0;i<8;i+=1)n[i]=Number(r&0xffn),r>>=8n;I(this.output,n),this.headerWritten=!0}flushPage(){if(this.builder.rowCount()===0)return;const e=y();this.builder.encode(e);const n=y();m(n,e.length),I(this.output,n),I(this.output,e),this.builder.reset()}}class ht{constructor(e){u(this,"rows",0);u(this,"cursor",0);u(this,"columns");this.columns=new Array(e).fill(null).map(()=>({kind:exports.FieldKind.Invalid,rowIndexes:[],uints:[],stringTable:[],stringIndexes:[],bools:[],ints:[],floats:[],bytes:[]}))}}class ge{constructor(e,n,r={}){u(this,"data");u(this,"schema");u(this,"options");u(this,"state");u(this,"offset",0);u(this,"headerRead",!1);this.data=e,this.schema=n,this.options=r,this.state=new ht(n.fields.length)}readRow(e){if(!this.headerRead&&!this.consumeHeader()||this.state.cursor>=this.state.rows&&!this.loadPage())return!1;const n=this.state.cursor,r=e.valuesSlice();for(let i=0;i<this.schema.fields.length;i+=1){const s=this.schema.fields[i],o=this.state.columns[i],a=r[i],c=o.rowIndexes[n]??-1;if(c<0){It(s,a);continue}switch(a.set=!0,s.valueKind()){case exports.FieldKind.Uint64:case exports.FieldKind.Ref:a.uint=o.uints[c];break;case exports.FieldKind.String:case exports.FieldKind.TimestampTZ:a.str=o.stringTable[o.stringIndexes[c]??0]??"";break;case exports.FieldKind.Bool:a.bool=o.bools[c];break;case exports.FieldKind.Int64:case exports.FieldKind.Date:case exports.FieldKind.DateTime:case exports.FieldKind.Timestamp:case exports.FieldKind.Duration:a.int=o.ints[c];break;case exports.FieldKind.Float64:a.float=o.floats[c];break;case exports.FieldKind.Bytes:a.bytes=o.bytes[c],a.borrowed=this.options.zeroCopyBytes??!1;break;default:throw new Error(`scrt: unsupported field kind ${s.valueKind()}`)}}return this.state.cursor+=1,!0}consumeHeader(){if(this.data.length<F.length+1+8)return!1;if(he.decode(this.data.subarray(0,F.length))!==F)throw new Error("scrt: invalid stream header");const n=this.data[F.length];if(n!==le)throw new Error(`scrt: unsupported version ${n}`);const r=this.data.subarray(F.length+1,F.length+9);let i=0n;for(let s=7;s>=0;s-=1)i=i<<8n|BigInt(r[s]);if(i!==this.schema.fingerprint())throw new Error("scrt: schema fingerprint mismatch");return this.offset=F.length+9,this.headerRead=!0,!0}loadPage(){if(this.offset>=this.data.length)return!1;const{value:e,bytesRead:n}=h(this.data,this.offset);this.offset+=n;const r=Number(e);if(r===0||this.offset+r>this.data.length)return!1;const i=this.data.subarray(this.offset,this.offset+r);return this.offset+=r,this.decodePage(i),!0}decodePage(e){let n=0;const{value:r,bytesRead:i}=h(e,n);n+=i;const s=Number(r),{value:o,bytesRead:a}=h(e,n);n+=a;const c=Number(o);if(c!==this.schema.fields.length)throw new Error("scrt: column count mismatch");this.state.rows=s,this.state.cursor=0;for(let d=0;d<c;d+=1){const{value:f,bytesRead:l}=h(e,n);n+=l;const g=Number(f),R=e[n];n+=1;const{value:$,bytesRead:Be}=h(e,n);n+=Be;const Ke=e.subarray(n,n+Number($));n+=Number($),this.decodeColumn(g,R,Ke,s)}}decodeColumn(e,n,r,i){const s=this.state.columns[e];s.kind=n;const o=mt(r,i);s.rowIndexes=o.indexes;const a=r.subarray(o.bytesRead);switch(n){case exports.FieldKind.Uint64:case exports.FieldKind.Ref:{const c=gt(a,o.setCount);s.uints=c.values;break}case exports.FieldKind.String:case exports.FieldKind.TimestampTZ:{const c=yt(a,o.setCount);s.stringTable=c.table,s.stringIndexes=c.indexes;break}case exports.FieldKind.Bool:{const c=bt(a,o.setCount);s.bools=c.values;break}case exports.FieldKind.Int64:case exports.FieldKind.Date:case exports.FieldKind.DateTime:case exports.FieldKind.Timestamp:case exports.FieldKind.Duration:{const c=wt(a,o.setCount);s.ints=c.values;break}case exports.FieldKind.Float64:{const c=pt(a,o.setCount);s.floats=c.values;break}case exports.FieldKind.Bytes:{const c=Ft(a,o.setCount,this.options.zeroCopyBytes??!1);s.bytes=c.values;break}default:throw new Error(`scrt: unsupported field kind ${n}`)}}}function mt(t,e){const{value:n,bytesRead:r}=h(t,0),i=Number(n);let s=r;const o=new Array(e).fill(-1);let a=0;for(let c=0;c<e;c+=1){const d=Math.floor(c/8),f=c%8;d<i&&t[s+d]&1<<f&&(o[c]=a,a+=1)}return s+=i,{indexes:o,setCount:a,bytesRead:s}}function gt(t,e){let n=0;const{value:r,bytesRead:i}=h(t,n);n+=i;const s=r&1n,o=Number(r>>1n);if(o!==e)throw new Error("scrt: uint column count mismatch");const a=new Array(o).fill(0n);if(o===0)return{values:a};if(s===0n)for(let c=0;c<o;c+=1){const d=h(t,n);n+=d.bytesRead,a[c]=d.value}else{let c=h(t,n);n+=c.bytesRead,a[0]=c.value;for(let d=1;d<o;d+=1)c=h(t,n),n+=c.bytesRead,a[d]=a[d-1]+c.value}return{values:a}}function wt(t,e){let n=0;const{value:r,bytesRead:i}=h(t,n);n+=i;const s=r&1n,o=Number(r>>1n);if(o!==e)throw new Error("scrt: int column count mismatch");const a=new Array(o).fill(0n);if(o===0)return{values:a};if(s===0n)for(let c=0;c<o;c+=1){const d=D(t,n);n+=d.bytesRead,a[c]=d.value}else{let c=D(t,n);n+=c.bytesRead,a[0]=c.value;for(let d=1;d<o;d+=1)c=D(t,n),n+=c.bytesRead,a[d]=a[d-1]+c.value}return{values:a}}function pt(t,e){let n=0;const{value:r,bytesRead:i}=h(t,n);n+=i;const s=Number(r);if(s!==e)throw new Error("scrt: float column count mismatch");const o=new Array(s).fill(0),a=new DataView(t.buffer,t.byteOffset,t.byteLength);for(let c=0;c<s;c+=1){if(n+8>t.length)throw new Error("scrt: float column truncated");o[c]=a.getFloat64(n,!0),n+=8}return{values:o}}function bt(t,e){let n=0;const{value:r,bytesRead:i}=h(t,n);n+=i;const s=Number(r);if(s!==e)throw new Error("scrt: bool column count mismatch");const o=new Array(s);for(let a=0;a<s;a+=1)o[a]=t[n+a]!==0;return{values:o}}function yt(t,e){let n=0;const{value:r,bytesRead:i}=h(t,n);n+=i;const s=Number(r),o=new Array(s);for(let l=0;l<s;l+=1){const g=h(t,n);n+=g.bytesRead;const R=Number(g.value),$=t.subarray(n,n+R);o[l]=he.decode($),n+=R}const{value:a,bytesRead:c}=h(t,n);n+=c;const d=Number(a);if(d!==e)throw new Error("scrt: string index count mismatch");const f=new Array(d);for(let l=0;l<d;l+=1){const g=h(t,n);n+=g.bytesRead,f[l]=Number(g.value)}return{table:o,indexes:f}}function Ft(t,e,n){let r=0;const{value:i,bytesRead:s}=h(t,r);r+=s;const o=Number(i);if(o!==e)throw new Error("scrt: bytes column count mismatch");const a=new Array(o);for(let c=0;c<o;c+=1){const d=h(t,r);r+=d.bytesRead;const f=Number(d.value),l=t.subarray(r,r+f);a[c]=n?l:Z(l),r+=f}return{values:a}}function Z(t){const e=new Uint8Array(t.length);return e.set(t),e}function It(t,e){e.set=!1;const n=t.defaultValue;if(n)switch(e.set=!0,n.kind){case exports.FieldKind.Uint64:case exports.FieldKind.Ref:e.uint=n.uintValue??0n;break;case exports.FieldKind.Int64:case exports.FieldKind.Date:case exports.FieldKind.DateTime:case exports.FieldKind.Timestamp:case exports.FieldKind.Duration:e.int=n.intValue??0n;break;case exports.FieldKind.Float64:e.float=n.floatValue??0;break;case exports.FieldKind.Bool:e.bool=n.boolValue??!1;break;case exports.FieldKind.String:case exports.FieldKind.TimestampTZ:e.str=n.stringValue??"";break;case exports.FieldKind.Bytes:e.bytes=n.bytesValue?Z(n.bytesValue):new Uint8Array;break;default:e.set=!1}}const Bt=new TextEncoder,Kt=new TextDecoder;function Tt(t,e,n={}){if(!t)throw new Error("scrt: schema is required for marshal");const r=new me(t,n.rowsPerPage??1024),i=new A(t);for(const s of Et(e)){if(s instanceof A){if(s.schema!==t)throw new Error("scrt: row schema mismatch during marshal");r.writeRow(s);continue}if(!St(s))throw new Error("scrt: marshal expects plain objects, maps, or Row instances");Nt(i,t,s),r.writeRow(i)}return r.finish()}function Dt(t,e,n){const r=[];for(const i of we(t,e,n))r.push(i);return r}function*we(t,e,n){if(!e)throw new Error("scrt: schema is required for unmarshal");const r=Ot(n),i=new ge(Lt(t),e,{zeroCopyBytes:r.zeroCopyBytes}),s=new A(e);for(;i.readRow(s);)yield Wt(s,e,r),s.reset()}function Et(t){return xt(t)?t:[t]}function xt(t){return t==null||typeof t=="string"?!1:typeof t[Symbol.iterator]=="function"}function St(t){return t instanceof Map?!0:t instanceof Date?!1:t&&typeof t=="object"?!(Array.isArray(t)||ArrayBuffer.isView(t)||t instanceof ArrayBuffer):!1}function Nt(t,e,n){t.reset();const r=Rt(n);e.fields.forEach((i,s)=>{const o=r(i.name);if(o==null)return;const a=$t(i,o);a&&t.setByIndex(s,a)})}function Rt(t){return t instanceof Map?e=>t.get(e):e=>t[e]}function $t(t,e){if(e==null)return null;const n=t.valueKind(),r={set:!0};switch(n){case exports.FieldKind.Uint64:case exports.FieldKind.Ref:return r.uint=Ut(e,t.name),r;case exports.FieldKind.Int64:return r.int=pe(e,t.name),r;case exports.FieldKind.Float64:return r.float=kt(e,t.name),r;case exports.FieldKind.Bool:return r.bool=At(e,t.name),r;case exports.FieldKind.String:return r.str=Ct(e,t.name),r;case exports.FieldKind.Bytes:return r.bytes=vt(e,t.name),r;case exports.FieldKind.Date:return r.int=O(P(e,t.name,exports.FieldKind.Date)),r;case exports.FieldKind.DateTime:case exports.FieldKind.Timestamp:return r.int=k(P(e,t.name,n)),r;case exports.FieldKind.TimestampTZ:return r.str=Vt(e,t.name),r;case exports.FieldKind.Duration:return r.int=Mt(e,t.name),r;default:throw new Error(`scrt: unsupported field kind ${n} for ${t.name}`)}}function Ut(t,e){const n=pe(t,e);if(n<0n)throw new Error(`scrt: ${e} cannot be negative`);return n}function pe(t,e){if(typeof t=="bigint")return t;if(typeof t=="number"){if(!Number.isFinite(t)||!Number.isInteger(t))throw new Error(`scrt: ${e} must be a finite integer`);if(Math.abs(t)>Number.MAX_SAFE_INTEGER)throw new Error(`scrt: ${e} exceeds safe integer range`);return BigInt(t)}if(typeof t=="string"){const n=t.trim();if(!n)throw new Error(`scrt: ${e} cannot be empty`);return BigInt(n)}throw new Error(`scrt: ${e} expects an integer-compatible value`)}function kt(t,e){if(typeof t=="number"){if(!Number.isFinite(t))throw new Error(`scrt: ${e} must be finite`);return t}if(typeof t=="bigint")return Number(t);if(typeof t=="string"){const n=Number(t.trim());if(Number.isNaN(n))throw new Error(`scrt: ${e} cannot parse float literal`);return n}throw new Error(`scrt: ${e} expects a float-compatible value`)}function At(t,e){if(typeof t=="boolean")return t;if(typeof t=="number"){if(!Number.isFinite(t))throw new Error(`scrt: ${e} must be finite`);return t!==0}if(typeof t=="string"){const n=t.trim().toLowerCase();if(n==="true"||n==="1")return!0;if(n==="false"||n==="0")return!1;throw new Error(`scrt: ${e} cannot parse boolean literal`)}throw new Error(`scrt: ${e} expects a boolean-compatible value`)}function Ct(t,e){if(typeof t=="string")return t;if(typeof t=="number"||typeof t=="boolean"||typeof t=="bigint")return String(t);if(t instanceof Date){if(!Number.isFinite(t.getTime()))throw new Error(`scrt: ${e} received invalid Date`);return t.toISOString()}if(t instanceof Uint8Array)return Kt.decode(t);throw new Error(`scrt: ${e} expects a string-compatible value`)}function vt(t,e){if(t instanceof Uint8Array)return t.slice();if(ArrayBuffer.isView(t)){const n=t;return new Uint8Array(n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength))}if(t instanceof ArrayBuffer)return new Uint8Array(t.slice(0));if(Array.isArray(t)){const n=new Uint8Array(t.length);return t.forEach((r,i)=>{if(typeof r!="number"||!Number.isFinite(r))throw new Error(`scrt: ${e} byte array contains non-number at index ${i}`);n[i]=r&255}),n}if(typeof t=="string")return Bt.encode(t);throw new Error(`scrt: ${e} expects bytes, ArrayBufferView, or string input`)}function P(t,e,n){if(t instanceof Date){if(!Number.isFinite(t.getTime()))throw new Error(`scrt: ${e} received invalid Date`);return t}if(typeof t=="string"){const r=t.trim();if(!r)throw new Error(`scrt: ${e} cannot parse empty temporal literal`);switch(n){case exports.FieldKind.Date:return x(r);case exports.FieldKind.DateTime:return S(r);case exports.FieldKind.Timestamp:return E(r);default:return E(r)}}if(typeof t=="number"){if(!Number.isFinite(t))throw new Error(`scrt: ${e} must be finite`);return be(t)}if(typeof t=="bigint")return ye(t);throw new Error(`scrt: ${e} expects Date, number, bigint, or string`)}function Vt(t,e){if(t instanceof Date){if(!Number.isFinite(t.getTime()))throw new Error(`scrt: ${e} received invalid Date`);return K(t)}if(typeof t=="string")return ee(t);if(typeof t=="number"){if(!Number.isFinite(t))throw new Error(`scrt: ${e} must be finite`);return K(be(t))}if(typeof t=="bigint")return K(ye(t));throw new Error(`scrt: ${e} expects Date, number, bigint, or string`)}function Mt(t,e){if(typeof t=="bigint")return t;if(typeof t=="number"){if(!Number.isFinite(t)||!Number.isInteger(t))throw new Error(`scrt: ${e} duration must be a finite integer`);if(Math.abs(t)>Number.MAX_SAFE_INTEGER)throw new Error(`scrt: ${e} duration exceeds safe integer range`);return BigInt(t)}if(typeof t=="string")return C(t);throw new Error(`scrt: ${e} expects bigint, number, or duration literal`)}function be(t){if(Number.isInteger(t))return T(v(BigInt(t)));const e=Math.trunc(t),n=t-e,r=BigInt(e)*1000000000n+BigInt(Math.trunc(n*1e9));return T(r)}function ye(t){return T(v(t))}function Lt(t){if(t instanceof Uint8Array)return t;if(ArrayBuffer.isView(t)){const e=t;return new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}if(t instanceof ArrayBuffer)return new Uint8Array(t);throw new Error("scrt: unsupported binary source")}function Ot(t){return{zeroCopyBytes:(t==null?void 0:t.zeroCopyBytes)??!1,numericMode:(t==null?void 0:t.numericMode)??"auto",temporalMode:(t==null?void 0:t.temporalMode)??"date",durationMode:(t==null?void 0:t.durationMode)??"bigint",objectFactory:(t==null?void 0:t.objectFactory)??(()=>({}))}}function Wt(t,e,n){const r=n.objectFactory(),i=t.valuesSlice();return e.fields.forEach((s,o)=>{const a=i[o];if(!a.set)return;const c=_t(s,a,n);Zt(r,s.name,c)}),r}function Zt(t,e,n){if(t instanceof Map){t.set(e,n);return}t[e]=n}function _t(t,e,n){const r=t.valueKind();switch(r){case exports.FieldKind.Uint64:case exports.FieldKind.Ref:return j(e.uint??0n,n.numericMode,t.name,!0);case exports.FieldKind.Int64:return j(e.int??0n,n.numericMode,t.name,!1);case exports.FieldKind.Float64:return e.float??0;case exports.FieldKind.Bool:return e.bool??!1;case exports.FieldKind.String:return e.str??"";case exports.FieldKind.Bytes:return e.bytes??new Uint8Array;case exports.FieldKind.Date:{const i=te(e.int??0n);return n.temporalMode==="string"?ne(i):i}case exports.FieldKind.DateTime:case exports.FieldKind.Timestamp:{const i=T(e.int??0n);return n.temporalMode==="string"?re(i):i}case exports.FieldKind.TimestampTZ:{const i=e.str??"";return i?n.temporalMode==="string"?i:N(i):n.temporalMode==="date"?new Date(0):""}case exports.FieldKind.Duration:return zt(e.int??0n,n.durationMode,t.name);default:throw new Error(`scrt: unsupported field kind ${r}`)}}function j(t,e,n,r){if(r&&t<0n)throw new Error(`scrt: ${n} stored value cannot be negative`);switch(e){case"bigint":return t;case"number":if(!L(t))throw new Error(`scrt: ${n} exceeds JS safe integer range`);return Number(t);default:return L(t)?Number(t):t}}function zt(t,e,n){switch(e){case"bigint":return t;case"number":if(!L(t))throw new Error(`scrt: duration ${n} exceeds JS safe integer range`);return Number(t);case"string":return ie(t);default:return t}}function L(t){return t<=BigInt(Number.MAX_SAFE_INTEGER)&&t>=BigInt(Number.MIN_SAFE_INTEGER)}const Fe=new TextDecoder,G="SCB1",Pt=1;function Ie(t){const e=new DataView(t);let n=0;for(let l=0;l<G.length;l+=1){if(e.getUint8(n)!==G.charCodeAt(l))throw new Error("scrt: invalid bundle magic");n+=1}const r=e.getUint8(n);if(n+=1,r!==Pt)throw new Error(`scrt: unsupported bundle version ${r}`);const i=e.getBigUint64(n,!0);n+=8;const s=e.getBigUint64(n,!0);n+=8;const o=new Date(Number(e.getBigInt64(n,!0)/1000000n));n+=8;const a=H(e,t,n);n+=a.bytes;const c=H(e,t,n);n+=c.bytes;const d=X(e,t,n);n+=d.bytes;const f=X(e,t,n);return{documentName:a.value,schemaName:c.value,documentFingerprint:i,schemaFingerprint:s,updatedAt:o,schemaText:Fe.decode(d.data),payload:f.data}}function H(t,e,n){const r=t.getUint16(n,!0),i=n+2,s=i+r;if(s>e.byteLength)throw new Error("scrt: bundle string exceeds buffer");return{value:Fe.decode(e.slice(i,s)),bytes:2+r}}function X(t,e,n){const r=t.getUint32(n,!0),i=n+4,s=i+r;if(s>e.byteLength)throw new Error("scrt: bundle blob exceeds buffer");return{data:new Uint8Array(e.slice(i,s)),bytes:4+r}}function q(t){const e=t.trim();return e?e.endsWith("/")?e.slice(0,-1):e:"http://localhost:8080"}async function B(t){if(t.ok)return t;const e=await t.text();throw new Error(e||t.statusText)}class jt{constructor(e="http://localhost:8080"){u(this,"baseUrl");this.baseUrl=q(e)}setBaseUrl(e){this.baseUrl=q(e)}url(e){return`${this.baseUrl}${e}`}async listDocuments(){return(await(await B(await fetch(this.url("/documents"),{headers:{Accept:"text/plain"}}))).text()).split(/\r?\n/).map(r=>r.trim()).filter(Boolean)}async downloadDocument(e){return(await B(await fetch(this.url(`/documents/${encodeURIComponent(e)}`),{headers:{Accept:"text/plain"}}))).text()}async saveDocument(e,n){await B(await fetch(this.url(`/documents/${encodeURIComponent(e)}`),{method:"POST",headers:{"Content-Type":"text/plain; charset=utf-8"},body:n}))}async deleteDocument(e){await B(await fetch(this.url(`/documents/${encodeURIComponent(e)}`),{method:"DELETE"}))}async uploadRecords(e,n,r){await B(await fetch(this.url(`/records/${encodeURIComponent(e)}/${encodeURIComponent(n)}`),{method:"POST",headers:{"Content-Type":"application/x-scrt"},body:r}))}async fetchRecords(e,n){const i=await(await B(await fetch(this.url(`/records/${encodeURIComponent(e)}/${encodeURIComponent(n)}`)))).arrayBuffer();return new Uint8Array(i)}async fetchBundle(e,n){const i=await(await B(await fetch(this.url(`/bundle?document=${encodeURIComponent(e)}&schema=${encodeURIComponent(n)}`)))).arrayBuffer();return Ie(i)}}exports.BinaryReader=$e;exports.BinaryWriter=Re;exports.DefaultValue=w;exports.Document=ce;exports.Field=oe;exports.Reader=ge;exports.Row=A;exports.Schema=ae;exports.ScrtHttpClient=jt;exports.Writer=me;exports.bufferLength=Ee;exports.bufferToUint8Array=Y;exports.canonicalTimestampTZ=ee;exports.concatByteBuffers=J;exports.createBuffer=y;exports.decodeBundle=Ie;exports.decodeDate=te;exports.decodeInstant=T;exports.encodeDate=O;exports.encodeInstant=k;exports.encodeUint64LE=ke;exports.formatDate=ne;exports.formatDuration=ie;exports.formatInstant=re;exports.formatTimestampTZ=K;exports.inferEpochNanoseconds=v;exports.marshalRecords=Tt;exports.numericTimestamp=W;exports.parseDate=x;exports.parseDateTime=S;exports.parseDuration=C;exports.parseSchema=Ye;exports.parseTimestamp=E;exports.parseTimestampTZ=N;exports.pushByte=b;exports.pushBytes=I;exports.readUvarint=h;exports.readVarint=D;exports.streamDecodedRows=we;exports.toSafeNumber=Ue;exports.unmarshalRecords=Dt;exports.writeUvarint=m;exports.writeVarint=U;
//# sourceMappingURL=scrt.cjs.js.map
